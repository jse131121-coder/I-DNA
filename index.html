<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHAT</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system; background:#fffbe6; }
    header { padding:14px; font-weight:700; text-align:center; background:#fff3b0; }
    .hidden { display:none; }
    .wrap { max-width:520px; margin:0 auto; }
    .box { background:#fff; margin:12px; padding:12px; border-radius:14px; }
    button { border:none; padding:6px 10px; border-radius:8px; background:#ffe066; font-weight:600; cursor:pointer; font-size:13px; }
    input, textarea { width:100%; padding:8px; margin-top:6px; border-radius:8px; border:1px solid #ddd; font-size:14px; }
    img.post-img { width:100%; border-radius:10px; margin-top:8px; }
    .meta { font-size:12px; color:#888; }
    .artist { color:#c92a2a; font-weight:700; }
    .comment { font-size:14px; margin-top:6px; }
    .reply { margin-left:16px; font-size:13px; color:#555; }
    .actions { display:flex; gap:6px; margin-top:6px; }
    .avatar { width:28px; height:28px; border-radius:50%; vertical-align:middle; margin-right:6px; object-fit:cover; }
  </style>
</head>
<body>
<header>CHAT</header>
<div class="wrap">

<!-- LOGIN -->
<div id="loginBox" class="box">
  <input id="loginId" placeholder="ID" />
  <input id="loginPw" type="password" placeholder="PW" />
  <button onclick="login()">Î°úÍ∑∏Ïù∏</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

  <div class="box">
    <span id="me"></span>
    <button onclick="openSetting()">‚öôÔ∏è</button>
    <button id="addUserBtn" class="hidden" onclick="openAddUser()">‚ûï</button>
  </div>

  <!-- WRITE -->
  <div id="writeBox" class="box hidden">
    <textarea id="postText" placeholder="ÏïÑÌã∞Ïä§Ìä∏Ïùò Í∏Ä"></textarea>
    <input type="file" id="imgInput" accept="image/*" />
    <div class="actions">
      <button onclick="addPost()">Í≤åÏãú</button>
    </div>
  </div>

  <!-- FEED -->
  <div id="feed"></div>
</div>
</div>

<script>
/* ===== DATA ===== */
const defaultUsers = {
  arin:{pw:'1234', role:'artist', name:'ARIN', avatar:''},
  yerin:{pw:'1234', role:'artist', name:'YERIN', avatar:''},
  fan01:{pw:'1111', role:'fan', name:'fan01', avatar:''}
};
let users = JSON.parse(localStorage.getItem('users')) || defaultUsers;
let posts = JSON.parse(localStorage.getItem('posts')) || [];
let me = null;

function save(){
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('posts', JSON.stringify(posts));
}

/* ===== LOGIN ===== */
function login(){
  const id = document.getElementById('loginId').value.trim();
  const pw = document.getElementById('loginPw').value.trim();
  if(!users[id] || users[id].pw !== pw){ alert('Î°úÍ∑∏Ïù∏ Ïã§Ìå®'); return; }
  me = { id, ...users[id] };
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  renderMe();
  if(me.role==='artist') document.getElementById('writeBox').classList.remove('hidden');
  if(me.id==='yerin') document.getElementById('addUserBtn').classList.remove('hidden');
  render();
}

function renderMe(){
  const meEl = document.getElementById('me');
  meEl.innerHTML = `${me.avatar?`<img class='avatar' src='${me.avatar}'>`:''}${me.name} ${me.role==='artist'?'üßë‚Äçüé§':''}`;
}

/* ===== POSTS ===== */
function addPost(){
  const text = postText.value.trim();
  if(!text) return;
  const file = imgInput.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = () => createPost(text, reader.result);
    reader.readAsDataURL(file);
  } else createPost(text, null);
}

function createPost(text, img){
  posts.unshift({
    id: Date.now(),
    author: me.id,
    text,
    img,
    comments: []
  });
  postText.value=''; imgInput.value='';
  save(); render();
}

function editPost(pid){
  const p = posts.find(p=>p.id===pid);
  const txt = prompt('ÏàòÏ†ï', p.text);
  if(txt!==null){ p.text=txt; save(); render(); }
}

function deletePost(pid){
  if(!confirm('ÏÇ≠Ï†ú?')) return;
  posts = posts.filter(p=>p.id!==pid);
  save(); render();
}

/* ===== COMMENTS ===== */
function addComment(pid, txt){
  const p = posts.find(p=>p.id===pid);
  p.comments.push({ author: me.id, text: txt, replies: [] });
  save(); render();
}

function addReply(pid, ci, txt){
  const p = posts.find(p=>p.id===pid);
  p.comments[ci].replies.push({ author: me.id, text: txt });
  save(); render();
}

/* ===== RENDER ===== */
function render(){
  feed.innerHTML='';
  posts.forEach(p=>{
    const u = users[p.author];
    const div = document.createElement('div');
    div.className='box';
    div.innerHTML = `
      <div class="meta ${u.role==='artist'?'artist':''}">${u.avatar?`<img class='avatar' src='${u.avatar}'>`:''}${u.name}</div>
      <div>${p.text}</div>
      ${p.img?`<img class='post-img' src='${p.img}'/>`:''}
      ${me.id===p.author?`
        <div class='actions'>
          <button onclick='editPost(${p.id})'>ÏàòÏ†ï</button>
          <button onclick='deletePost(${p.id})'>ÏÇ≠Ï†ú</button>
        </div>`:''}
      <div>
        ${p.comments.map((c,i)=>`
          <div class='comment'><b>${users[c.author].name}</b> ${c.text}
            ${me.role==='artist'?`<input placeholder='ÎãµÍ∏Ä' onkeydown="if(event.key==='Enter')addReply(${p.id},${i},this.value)"/>`:''}
            ${c.replies.map(r=>`<div class='reply'>${users[r.author].name}: ${r.text}</div>`).join('')}
          </div>`).join('')}
        <input placeholder='ÎåìÍ∏Ä' onkeydown="if(event.key==='Enter')addComment(${p.id},this.value)" />
      </div>
    `;
    feed.appendChild(div);
  });
}

/* ===== SETTINGS ===== */
function openSetting(){
  const name = prompt('Ïù¥Î¶Ñ Î≥ÄÍ≤Ω', me.name);
  const pw = prompt('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω', me.pw);
  const avatar = prompt('ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ URL', me.avatar || '');
  if(name) users[me.id].name = me.name = name;
  if(pw) users[me.id].pw = me.pw = pw;
  if(avatar!==null) users[me.id].avatar = me.avatar = avatar;
  save(); renderMe(); render();
}

/* ===== ADMIN ===== */
function openAddUser(){
  if(me.id!=='yerin') return alert('Í∂åÌïú ÏóÜÏùå');
  const id=prompt('ID');
  const pw=prompt('PW');
  const role=prompt('fan / artist');
  const name=prompt('Ïù¥Î¶Ñ');
  if(id&&pw&&role){ users[id]={pw,role,name:name||id,avatar:''}; save(); alert('Í≥ÑÏ†ï Ï∂îÍ∞Ä ÏôÑÎ£å'); }
}
</script>
</body>
</html>
