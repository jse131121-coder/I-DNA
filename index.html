<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Twin Service</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<style>
body {
  font-family: system-ui;
  background: #f7fff4;
  margin: 0;
  padding: 16px;
}
.card {
  background: white;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
}
button {
  background: #a6f77b;
  border: none;
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
}
.hidden { display:none }
.badge {
  display:inline-block;
  width:10px;height:10px;
  border-radius:50%;
}
textarea,input { width:100%; margin-top:6px }
</style>
</head>
<body>

<h2>ğŸŸ¢ Twin Service</h2>

<div id="login" class="card">
  <input id="email" placeholder="email">
  <input id="password" type="password" placeholder="password">
  <button onclick="login()">ë¡œê·¸ì¸</button>
</div>

<div id="app" class="hidden">

<!-- PROFILE -->
<div class="card">
  <h3>í”„ë¡œí•„</h3>
  <input id="name" placeholder="ì´ë¦„">
  <input id="badge" placeholder="#A6F77B">
  <input type="file" id="avatar">
  <button onclick="saveProfile()">ì €ì¥</button>
</div>

<!-- COMMUNITY -->
<div class="card">
  <h3>ì»¤ë®¤ë‹ˆí‹°</h3>
  <textarea id="postText" placeholder="ê¸€ ì‘ì„±"></textarea>
  <button onclick="addPost()">ë“±ë¡</button>
  <div id="posts"></div>
</div>

<!-- LETTERS -->
<div class="card">
  <h3>ğŸ“¨ ë°›ì€ í¸ì§€</h3>
  <div id="letters"></div>
</div>

<!-- CHAT -->
<div id="chatBox" class="card hidden">
  <h3>ğŸ’¬ ì±„íŒ…</h3>
  <input id="chatText">
  <button onclick="sendChat()">ë³´ë‚´ê¸°</button>
  <div id="chat"></div>
</div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>âš™ ê´€ë¦¬ì</h3>
  <button onclick="toggleChat(true)">ì±„íŒ… ì—´ê¸°</button>
  <button onclick="toggleChat(false)">ì±„íŒ… ë‹«ê¸°</button>
</div>

</div>

<script>
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_ID",
  storageBucket: "YOUR_BUCKET",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let currentUser, profile;

auth.onAuthStateChanged(async user => {
  if (!user) return;
  currentUser = user;
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");

  const snap = await db.collection("users").doc(user.uid).get();
  profile = snap.exists ? snap.data() : { role:"free" };

  if (profile.role === "admin")
    document.getElementById("admin").classList.remove("hidden");

  db.collection("settings").doc("chat").onSnapshot(s=>{
    document.getElementById("chatBox")
      .classList.toggle("hidden", !s.data().enabled);
  });

  loadPosts(); loadLetters(); loadChat();
});

function login(){
  auth.signInWithEmailAndPassword(
    email.value, password.value
  );
}

function saveProfile(){
  const file = avatar.files[0];
  if(file){
    const ref = storage.ref("avatars/"+currentUser.uid);
    ref.put(file).then(()=>ref.getDownloadURL()
      .then(url=>updateProfile(url)));
  } else updateProfile();
}

function updateProfile(url){
  db.collection("users").doc(currentUser.uid).set({
    name:name.value,
    badge:badge.value,
    avatar:url||profile.avatar,
    role:profile.role||"free"
  },{merge:true});
}

function addPost(){
  db.collection("posts").add({
    text:postText.value,
    uid:currentUser.uid,
    created:Date.now()
  });
  postText.value="";
}

function loadPosts(){
  db.collection("posts").orderBy("created","desc")
    .onSnapshot(s=>{
      posts.innerHTML="";
      s.forEach(d=>{
        posts.innerHTML+=`<div>${d.data().text}</div>`;
      });
    });
}

function loadLetters(){
  db.collection("letters")
    .where("to","==",currentUser.uid)
    .onSnapshot(s=>{
      letters.innerHTML="";
      s.forEach(d=>{
        letters.innerHTML+=`<div>${d.data().text}</div>`;
      });
    });
}

function toggleChat(v){
  db.collection("settings").doc("chat").set({enabled:v});
}

function sendChat(){
  db.collection("chat").add({
    text:chatText.value,
    uid:currentUser.uid
  });
  chatText.value="";
}

function loadChat(){
  db.collection("chat").orderBy("created")
    .onSnapshot(s=>{
      chat.innerHTML="";
      s.forEach(d=>{
        chat.innerHTML+=`<div>${d.data().text}</div>`;
      });
    });
}
</script>
</body>
</html>

