import streamlit as st
import json, os
from datetime import datetime
from streamlit_autorefresh import st_autorefresh

st.set_page_config(page_title="Community", layout="centered")

# ======================
# AUTO REFRESH (5초)
# ======================
st_autorefresh(interval=5000, key="refresh")

# ======================
# STYLE (모바일 + 연노랑)
# ======================
st.markdown("""
<style>
body { background:#fffef6; }
.app { max-width:420px; margin:auto; }
.block { background:#fff4c2; padding:12px; border-radius:14px; margin-bottom:14px; }
.row { display:flex; gap:10px; align-items:flex-start; }
.pf { width:36px; height:36px; border-radius:50%; }
.name { font-weight:700; }
.artist { color:#c79a00; }
.msg { background:white; padding:10px 12px; border-radius:12px; margin-top:6px; }
.reply { background:#fff1a8; padding:8px 10px; border-radius:10px; margin-left:46px; font-size:0.9em; }
.time { font-size:0.7em; color:#777; margin-top:4px; }
input, textarea { border-radius:10px !important; }
</style>
""", unsafe_allow_html=True)

# ======================
# UTIL
# ======================
def load(path, default):
    if not os.path.exists(path):
        return default
    with open(path, "r", encoding="utf-8") as f:
        return json.load(f)

def save(path, data):
    with open(path, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

users = load("data/users.json", {})
messages = load("data/messages.json", [])

# ======================
# LOGIN
# ======================
if "login" not in st.session_state:
    st.session_state.login = False

if not st.session_state.login:
    st.markdown("<div class='app'>", unsafe_allow_html=True)
    st.title("LOGIN")
    uid = st.text_input("ID")
    pw = st.text_input("PASSWORD", type="password")

    if st.button("ENTER"):
        if uid in users and users[uid]["password"] == pw:
            st.session_state.login = True
            st.session_state.uid = uid
            st.session_state.user = users[uid]
            st.experimental_rerun()
        else:
            st.error("로그인 실패")
    st.markdown("</div>", unsafe_allow_html=True)
    st.stop()

me = st.session_state.user

# ======================
# MAIN
# ======================
st.markdown("<div class='app'>", unsafe_allow_html=True)
st.title("COMMUNITY")

# 아티스트 채팅 입력
if me["role"] == "artist":
    txt = st.text_area("메시지 입력", height=80)
    if st.button("SEND"):
        messages.insert(0, {
            "author": me["display"],
            "profile": me["profile"],
            "role": "artist",
            "text": txt,
            "time": datetime.now().strftime("%Y-%m-%d %H:%M"),
            "comments": []
        })
        save("data/messages.json", messages)
        st.experimental_rerun()

# ======================
# MESSAGE LOOP
# ======================
for i, m in enumerate(messages):
    st.markdown(f"""
    <div class="block">
      <div class="row">
        <img class="pf" src="{m['profile']}">
        <div>
          <div class="name artist">★ {m['author']}</div>
          <div class="msg">{m['text']}</div>
          <div class="time">{m['time']}</div>
        </div>
      </div>
    </div>
    """, unsafe_allow_html=True)

    # 댓글
    for j, c in enumerate(m["comments"]):
        st.markdown(f"""
        <div class="row">
          <img class="pf" src="{c['profile']}">
          <div class="msg">{c['author']} : {c['text']}</div>
        </div>
        """, unsafe_allow_html=True)

        if "reply" in c:
            st.markdown(f"""
            <div class="reply">★ {c['reply']['author']} : {c['reply']['text']}</div>
            """, unsafe_allow_html=True)

        if me["role"] == "artist" and "reply" not in c:
            r = st.text_input("대댓글", key=f"r_{i}_{j}")
            if st.button("답글", key=f"rb_{i}_{j}"):
                c["reply"] = {
                    "author": me["display"],
                    "text": r
                }
                save("data/messages.json", messages)
                st.experimental_rerun()

    # 팬 댓글
    cmt = st.text_input("댓글", key=f"c_{i}")
    if st.button("등록", key=f"cb_{i}"):
        m["comments"].append({
            "author": me["display"],
            "profile": me["profile"],
            "text": cmt
        })
        save("data/messages.json", messages)
        st.experimental_rerun()

st.markdown("</div>", unsafe_allow_html=True)


                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                 
