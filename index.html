<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Twin Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<style>
body{background:#f6fff3;font-family:system-ui;margin:0;padding:14px}
.card{background:#fff;border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:0 6px 20px rgba(0,0,0,.05)}
button{background:#a6f77b;border:none;padding:8px 14px;border-radius:20px}
input,textarea{width:100%;border:1px solid #ddd;border-radius:12px;padding:8px;margin-top:6px}
.badge{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:4px}
.hidden{display:none}
.small{font-size:12px;color:#666}
.reply{margin-left:16px;border-left:2px solid #eaeaea;padding-left:8px}
</style>
</head>

<body>

<h2>ğŸŸ¢ Twin Space</h2>

<div id="login" class="card">
  <input id="email" placeholder="email">
  <input id="pw" type="password" placeholder="password">
  <button onclick="login()">ë¡œê·¸ì¸</button>
</div>

<div id="app" class="hidden">

<!-- PROFILE -->
<div class="card">
  <h3>í”„ë¡œí•„</h3>
  <input id="name" placeholder="ì´ë¦„">
  <input id="badge" placeholder="#A6F77B">
  <input type="file" id="avatar">
  <button onclick="saveProfile()">ì €ì¥</button>
</div>

<!-- COMMUNITY -->
<div class="card">
  <h3>ì»¤ë®¤ë‹ˆí‹°</h3>
  <textarea id="postText" placeholder="ê¸€ ì‘ì„±"></textarea>
  <button onclick="addPost()">ì˜¬ë¦¬ê¸°</button>
  <div id="posts"></div>
</div>

<!-- LETTER -->
<div class="card">
  <h3>ğŸ“¨ ë°›ì€ í¸ì§€</h3>
  <div id="letters"></div>
</div>

<!-- CHAT -->
<div id="chatBox" class="card hidden">
  <h3>ğŸ’¬ ì±„íŒ…</h3>
  <input id="chatInput">
  <button onclick="sendChat()">ì „ì†¡</button>
  <div id="chat"></div>
</div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>ê´€ë¦¬ì</h3>
  <button onclick="toggleChat(true)">ì±„íŒ… ì—´ê¸°</button>
  <button onclick="toggleChat(false)">ì±„íŒ… ë‹«ê¸°</button>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"YOUR_KEY",
  authDomain:"YOUR_DOMAIN",
  projectId:"YOUR_ID",
  storageBucket:"YOUR_BUCKET",
  appId:"YOUR_APP_ID"
});

const auth=firebase.auth(),db=firebase.firestore(),st=firebase.storage();
let me,profile={};

auth.onAuthStateChanged(async u=>{
 if(!u)return;
 me=u;
 login.classList.add("hidden");
 app.classList.remove("hidden");

 const snap=await db.collection("users").doc(u.uid).get();
 profile=snap.exists?snap.data():{role:"free"};

 if(profile.role==="admin") admin.classList.remove("hidden");

 db.collection("settings").doc("chat")
 .onSnapshot(s=>chatBox.classList.toggle("hidden",!s.data().enabled));

 loadPosts();loadLetters();loadChat();
});

function login(){
 auth.signInWithEmailAndPassword(email.value,pw.value);
}

function saveProfile(){
 const f=avatar.files[0];
 if(f){
  const r=st.ref("avatars/"+me.uid);
  r.put(f).then(()=>r.getDownloadURL().then(u=>update(u)));
 }else update();
}
function update(url){
 db.collection("users").doc(me.uid).set({
  name:name.value,badge:badge.value,avatar:url||profile.avatar,role:profile.role||"free"
 },{merge:true});
}

function addPost(){
 db.collection("posts").add({text:postText.value,uid:me.uid,ts:Date.now()});
 postText.value="";
}

function loadPosts(){
 db.collection("posts").orderBy("ts","desc").onSnapshot(s=>{
  posts.innerHTML="";
  s.forEach(d=>{
   const id=d.id;
   posts.innerHTML+=`
    <div class="card">
     ${d.data().text}
     <input placeholder="ëŒ“ê¸€" onkeydown="if(event.key==='Enter')addComment('${id}',this)">
     <div id="c_${id}"></div>
    </div>`;
   loadComments(id);
  });
 });
}

function addComment(pid,input){
 db.collection("posts").doc(pid).collection("comments")
 .add({text:input.value,uid:me.uid,ts:Date.now()});
 input.value="";
}

function loadComments(pid){
 db.collection("posts").doc(pid).collection("comments")
 .orderBy("ts").onSnapshot(s=>{
  const box=document.getElementById("c_"+pid); box.innerHTML="";
  s.forEach(c=>{
   const cid=c.id;
   box.innerHTML+=`
    <div>
     ${c.data().text}
     <input class="small" placeholder="ëŒ€ëŒ“ê¸€" 
      onkeydown="if(event.key==='Enter')addReply('${pid}','${cid}',this)">
     <div id="r_${cid}" class="reply"></div>
    </div>`;
   loadReplies(pid,cid);
  });
 });
}

function addReply(pid,cid,input){
 db.collection("posts").doc(pid)
 .collection("comments").doc(cid)
 .collection("replies").add({text:input.value,uid:me.uid,ts:Date.now()});
 input.value="";
}

function loadReplies(pid,cid){
 db.collection("posts").doc(pid)
 .collection("comments").doc(cid)
 .collection("replies").orderBy("ts")
 .onSnapshot(s=>{
  const box=document.getElementById("r_"+cid); box.innerHTML="";
  s.forEach(r=>box.innerHTML+=`<div>${r.data().text}</div>`);
 });
}

function loadLetters(){
 db.collection("letters").where("to","==",me.uid)
 .onSnapshot(s=>{
  letters.innerHTML="";
  s.forEach(l=>letters.innerHTML+=`<div>${l.data().text}</div>`);
 });
}

function toggleChat(v){
 db.collection("settings").doc("chat").set({enabled:v});
}

function sendChat(){
 db.collection("chat").add({text:chatInput.value,ts:Date.now()});
 chatInput.value="";
}

function loadChat(){
 db.collection("chat").orderBy("ts").onSnapshot(s=>{
  chat.innerHTML="";
  s.forEach(m=>chat.innerHTML+=`<div>${m.data().text}</div>`);
 });
}
</script>
</body>
</html>

